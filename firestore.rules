rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user email is allowed
    function isValidUser() {
      return request.auth != null && (
        // Check if email is in exceptions list
        request.auth.token.email == 'taishi14ki@gmail.com' ||
        // Check if email ends with allowed domain
        request.auth.token.email.matches('.*@g.ecc.u-tokyo.ac.jp')
      );
    }

    // Users collection
    match /users/{userId} {
      allow read: if isValidUser();
      allow create: if isValidUser() && request.auth.uid == userId;
      allow update: if isValidUser() && request.auth.uid == userId;
      allow delete: if false;
    }

    // Items collection
    match /items/{itemId} {
      allow read: if isValidUser();
      allow create: if isValidUser() && request.resource.data.userId == request.auth.uid;
      allow update: if isValidUser() && resource.data.userId == request.auth.uid;
      allow delete: if isValidUser() && resource.data.userId == request.auth.uid;
    }

    // AI usage tracking collection
    match /ai_usage/{usageId} {
      allow read: if isValidUser() && request.auth.uid == resource.data.userId;
      allow write: if isValidUser();
    }

    // Conversations collection (DM機能)
    match /conversations/{conversationId} {
      // Only participants can read/write
      allow read: if isValidUser() && request.auth.uid in resource.data.participants;
      allow create: if isValidUser() && request.auth.uid in request.resource.data.participants;
      allow update: if isValidUser() && request.auth.uid in resource.data.participants;
      allow delete: if false;

      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isValidUser() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        allow create: if isValidUser() 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
          && request.resource.data.senderId == request.auth.uid;
        allow update: if isValidUser() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        allow delete: if false;
      }
    }
  }
}
