# AI機能のセットアップガイド

このガイドでは、商品説明の自動生成機能（Gemini API）のセットアップ方法を説明します。

## 機能概要

- **商品説明の自動生成**: 商品名、カテゴリ、価格などから魅力的な説明文を自動生成
- **使用モデル**: Gemini 1.5 Flash（高速で効率的なモデル）
- **使用回数制限**: ユーザーあたり1日3回まで利用可能
- **プロンプトチューニング**: 駒場祭の雰囲気に合った文体で生成

## セットアップ手順

### 1. Gemini API キーの取得

1. [Google AI Studio](https://ai.google.dev/) にアクセス
2. Googleアカウントでログイン
3. 「Get API key」をクリック
4. 新しいAPIキーを作成

### 2. 環境変数の設定

#### ローカル開発環境

1. `.env` ファイルを作成（`.env.example`を参考に）
2. 以下の環境変数を追加：

```bash
GEMINI_API_KEY=your_actual_api_key_here
```

**重要**: `.env` ファイルは `.gitignore` に含まれています。APIキーは絶対にGitにコミットしないでください。

#### 本番環境（Firebase App Hosting / Cloud Run）

1. Firebase Console または Cloud Run のコンソールにアクセス
2. 環境変数セクションに移動
3. `GEMINI_API_KEY` という名前で環境変数を追加
4. 値にAPIキーを設定

### 3. 依存関係のインストール

```bash
npm install
```

これにより、`@google/generative-ai` パッケージがインストールされます。

### 4. 動作確認

1. サーバーを起動：

```bash
npm run dev
```

2. ブラウザで商品登録ページにアクセス
3. 商品名とカテゴリを入力
4. 「✨ AIで生成」ボタンをクリック
5. 説明文が自動生成されることを確認

## 使用方法

### フロントエンド（ユーザー視点）

1. 商品登録ページで商品名とカテゴリを入力
2. 「✨ AIで生成」ボタンをクリック
3. 生成された説明文が自動で入力される
4. 必要に応じて編集可能
5. 1日3回まで利用可能

### API仕様

#### POST /api/ai/generate-description

**リクエスト**:
```json
{
  "name": "たこ焼き",
  "category": "飲食物",
  "price": 300,
  "exhibitorName": "駒場たこ焼き研究会"
}
```

**レスポンス**:
```json
{
  "description": "駒場祭名物のふわふわたこ焼きです。外はカリッと、中はトロッとした食感が特徴です。",
  "remaining": 2
}
```

**エラーレスポンス** (429 Too Many Requests):
```json
{
  "error": "本日の生成回数の上限に達しました。明日また利用できます。",
  "remaining": 0
}
```

#### GET /api/ai/usage

**レスポンス**:
```json
{
  "remaining": 2,
  "used": 1,
  "limit": 3
}
```

## プロンプトのカスタマイズ

`services/aiService.ts` の `createPrompt` 関数でプロンプトをカスタマイズできます。

駒場祭向けに最適化された現在のプロンプト：
- 2〜3文程度の簡潔な説明
- 親しみやすい「です・ます調」
- 商品の魅力を強調
- 実在しない詳細情報は追加しない

## トラブルシューティング

### API

キーが設定されていない

**症状**: コンソールに「Warning: GEMINI_API_KEY is not set」と表示

**解決方法**:
1. `.env` ファイルに `GEMINI_API_KEY` が設定されているか確認
2. サーバーを再起動

### 429エラー（制限超過）

**症状**: 「本日の生成回数の上限に達しました」エラー

**解決方法**:
1. 翌日まで待つ（日付が変わると自動リセット）
2. または `routes/ai.ts` の `MAX_GENERATIONS_PER_DAY` を変更（開発時のみ）

### 生成が遅い

**症状**: ボタンを押してから数秒かかる

**解決方法**:
- これは正常動作です（Gemini APIの応答時間）
- ローディングスピナーが表示されます

## コスト管理

### Gemini API の無料枠

- **1日あたり**: 150万トークンまで無料
- **この実装での使用量**: 約500トークン/回（入力+出力）
- **想定**: 30ユーザー × 3回/日 = 90回/日 ≈ 45,000トークン/日
- **結論**: 無料枠内で十分運用可能

### 使用量の監視

[Google AI Studio](https://ai.google.dev/) のダッシュボードで使用量を確認できます。

## セキュリティ注意事項

1. **APIキーの管理**:
   - `.env` ファイルをGitにコミットしない
   - APIキーを他人と共有しない
   - 本番環境では環境変数として安全に管理

2. **使用回数制限**:
   - Firestoreに記録（`ai_usage` コレクション）
   - ユーザーIDと日付でドキュメント管理
   - 自動的に日次リセット

3. **認証**:
   - すべてのAI APIエンドポイントは認証必須
   - `authMiddleware` で保護

## 実装ファイル

- `services/aiService.ts`: Gemini API呼び出しとプロンプト管理
- `routes/ai.ts`: APIエンドポイントと使用回数制限
- `services/itemApi.ts`: フロントエンドAPI呼び出し関数
- `components/ItemForm.tsx`: UI実装（生成ボタン）
- `app.ts`: ルート設定

## サポート

問題が発生した場合は、以下を確認してください：

1. コンソールログ（エラーメッセージ）
2. ネットワークタブ（API呼び出しの確認）
3. 環境変数の設定
4. Firestore の `ai_usage` コレクション
